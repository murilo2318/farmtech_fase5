<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmTech Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar { transition: all 0.3s; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .sensor-status-active { background-color: rgba(74, 222, 128, 0.1); border-left: 4px solid rgb(74, 222, 128); }
        .sensor-status-inactive { background-color: rgba(248, 113, 113, 0.1); border-left: 4px solid rgb(248, 113, 113); }
        .sensor-status-maintenance { background-color: rgba(251, 191, 36, 0.1); border-left: 4px solid rgb(251, 191, 36); }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar bg-white w-64 md:w-20 lg:w-64 border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                <div class="md:hidden lg:block">
                    <h1 class="text-xl font-bold text-green-600">FarmTech</h1>
                </div>
                <div class="hidden md:block lg:hidden text-center">
                    <i class="fas fa-leaf text-green-600 text-2xl"></i>
                </div>
                <button class="md:hidden text-gray-500" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <nav class="flex-1 overflow-y-auto">
                <ul class="p-4 space-y-2">
                    <li>
                        <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100 group">
                            <i class="fas fa-tachometer-alt text-green-600 w-6"></i>
                            <span class="ml-3 hidden md:hidden lg:block">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100 group">
                            <i class="fas fa-map-marked-alt text-blue-600 w-6"></i>
                            <span class="ml-3 hidden md:hidden lg:block">Fazendas</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100 group">
                            <i class="fas fa-seedling text-yellow-600 w-6"></i>
                            <span class="ml-3 hidden md:hidden lg:block">Culturas</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100 group">
                            <i class="fas fa-microchip text-purple-600 w-6"></i>
                            <span class="ml-3 hidden md:hidden lg:block">Sensores</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <header class="bg-white shadow-sm">
                <div class="px-4 py-4 flex items-center justify-between">
                    <h1 class="text-xl font-semibold text-gray-800">Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button class="p-2 rounded-full hover:bg-gray-100">
                                <i class="fas fa-bell text-gray-500"></i>
                                <span class="absolute top-0 right-0 h-2 w-2 rounded-full bg-red-500"></span>
                            </button>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                            <span class="ml-2 hidden md:block">Admin</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="p-4">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="stats-cards">
                    <!-- Cards serão gerados via JS -->
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Temperatura (Últimos 7 dias)</h2>
                        </div>
                        <div class="h-64">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold">Umidade (Últimos 7 dias)</h2>
                        </div>
                        <div class="h-64">
                            <canvas id="humidityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sensor Status -->
                <div class="bg-white rounded-lg shadow p-4 mb-6">
                    <h2 class="text-lg font-semibold mb-4">Status dos Sensores</h2>
                    <div id="sensor-status">
                        <!-- Sensores via JS -->
                    </div>
                </div>

                <!-- Yield Prediction -->
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 class="text-lg font-semibold mb-4">Previsão de Produtividade</h2>
                    <div id="yield-container">
                        <!-- Produtividade via JS -->
                    </div>
                    <div class="h-64 mt-4">
                        <canvas id="yieldChart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Sidebar toggle
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('hidden');
        });

        // Função para carregar cards
        async function loadStats() {
            const res = await fetch('/api/sensors');
            const sensors = await res.json();
            const cardContainer = document.getElementById('stats-cards');
            cardContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Fazendas</p>
                            <h3 class="text-lg font-semibold">1</h3>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Talhões</p>
                            <h3 class="text-lg font-semibold">1</h3>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Culturas</p>
                            <h3 class="text-lg font-semibold">${new Set(sensors.map(s => s.tipo)).size}</h3>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-microchip"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Sensores</p>
                            <h3 class="text-lg font-semibold">${sensors.length}</h3>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadSensors() {
            const res = await fetch('/api/sensors');
            const sensors = await res.json();
            const container = document.getElementById('sensor-status');
            container.innerHTML = '';
            sensors.forEach(s => {
                const statusClass = s.status === 'ATIVO' ? 'sensor-status-active' :
                                    s.status === 'INATIVO' ? 'sensor-status-inactive' : 'sensor-status-maintenance';
                container.innerHTML += `
                    <div class="mb-4 p-4 rounded-lg ${statusClass}">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-medium">${s.nome} - ${s.localizacao}</h3>
                                <p class="text-sm text-gray-500">${s.tipo}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass.includes('active') ? 'bg-green-100 text-green-800' : statusClass.includes('inactive') ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${s.status}</span>
                        </div>
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span>Instalado em: ${new Date(s.data_instalacao).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            });
        }

        async function loadTemperatureChart() {
            const res = await fetch('/api/temperature');
            const data = await res.json();
            const ctx = document.getElementById('temperatureChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.dia).toLocaleDateString('pt-BR', { weekday: 'short' })),
                    datasets: [{
                        label: 'Temperatura (°C)',
                        data: data.map(d => d.temperatura),
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function loadHumidityChart() {
            const res = await fetch('/api/humidity');
            const data = await res.json();
            const ctx = document.getElementById('humidityChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.dia).toLocaleDateString('pt-BR', { weekday: 'short' })),
                    datasets: [{
                        label: 'Umidade (%)',
                        data: data.map(d => d.umidade),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function loadYield() {
            const res = await fetch('/api/yield');
            const data = await res.json();
            const container = document.getElementById('yield-container');
            container.innerHTML = '';
            data.forEach(d => {
                const percent = Math.min(100, (d.realizado/d.previsto)*100);
                container.innerHTML += `
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-medium">${d.cultura}</h3>
                            <span class="text-sm text-gray-500">Modelo: ${d.modelo}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-500 h-4 rounded-full" style="width: ${percent}%"></div>
                        </div>
                        <div class="flex justify-between text-sm text-gray-500 mt-1">
                            <span>${d.previsto} t/ha</span>
                            <span>${d.realizado} t/ha</span>
                        </div>
                    </div>
                `; 
            });

            const ctx = document.getElementById('yieldChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.cultura),
                    datasets: [
                        { label: 'Previsto', data: data.map(d => d.previsto), backgroundColor: 'rgba(74, 222, 128, 0.7)' },
                        { label: 'Realizado', data: data.map(d => d.realizado), backgroundColor: 'rgba(249, 115, 22, 0.7)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // Inicialização
        loadStats();
        loadSensors();
        loadTemperatureChart();
        loadHumidityChart();
        loadYield();
    </script>
</body>
</html>
